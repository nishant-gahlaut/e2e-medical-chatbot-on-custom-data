<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook LLM - Your Personal AI Sathi</title>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Link Google Fonts (Roboto) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Link Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/000000/chat--v1.png">
</head>
<body>
    <!-- Removed old Hamburger Menu -->

    <div class="app-container new-layout"> <!-- Add class for new layout -->
        <!-- New App Navigation Sidebar -->
        <nav class="app-nav" id="app-nav">
            <button class="nav-button" id="show-chat-btn" title="Show Chat">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </button>
            <button class="nav-button" id="show-upload-btn" title="Upload Content">
                <i class="fas fa-upload"></i>
                <span>Upload</span>
            </button>
            <button class="nav-button" id="show-library-btn" title="Show Library">
                <i class="fas fa-book-open"></i>
                <span>Library</span>
            </button>
            <!-- Add other nav items here later if needed -->
        </nav>

        <!-- Main Content Area (holds chat and library) -->
        <div class="main-content-area">
            
            <!-- Chat Area (Existing <main>) -->
            <main class="chat-area" id="chat-area">
                <!-- ... (keep existing chat header, container, input section) ... -->
                 <div class="chat-header">
                    <h1>Notebook<span class="accent-text"> LLM</span><span class="accent-mark">.</span><span class="accent-mark">!</span></h1>
                    <p>Your AI assistant for querying documents and web pages.</p>
                </div>
                <div class="chat-container" id="chatContainer">
                     <div class="message bot-message">Upload PDFs, add web pages, and ask me anything about them.</div>
                </div>
                 <div class="input-section">
                    <button class="btn btn-secondary btn-clear-chat-inline small-btn" onclick="clearChatUI()" title="Clear Chat History">
                         <i class="fas fa-broom"></i>
                     </button>
                    <input type="text" class="chat-input" id="userInput" placeholder="ask something...">
                    <button class="btn btn-send" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </main>

            <!-- New Upload View (Initially Hidden) -->
            <div class="library-view upload-view hidden" id="upload-view">
                <div class="library-header-controls">
                    <button class="btn btn-secondary back-button" id="back-to-chat-btn-upload">
                        <i class="fas fa-arrow-left"></i> Back to Chat
                    </button>
                </div>
                
                <!-- Content area for upload sections -->
                <div class="library-content-area upload-content-area">
                     <!-- Top Row: Add Content Cards -->
                    <div class="add-content-container">
                        <!-- Upload Card -->
                        <div class="add-card upload-card">
                            <h4><i class="fas fa-file-upload"></i> Upload Documents</h4>
                            <p class="card-description">Select PDF, TXT, etc.</p>
                            <label for="fileInputUploadView" class="btn btn-primary btn-upload full-width">
                                <i class="fas fa-cloud-upload-alt"></i> Select File(s)
                            </label>
                            <input type="file" id="fileInputUploadView" multiple style="display: none;">
                            <small id="file-info-upload" class="centered-text">No files selected</small>
                            <button class="btn btn-secondary btn-trigger-upload full-width" onclick="uploadFiles()">Confirm Upload</button>
                            <div id="upload-status-upload" class="upload-status compact hidden">
                                <div class="upload-progress-container">
                                    <div id="upload-progress-bar-upload" class="upload-progress-bar"></div>
                                </div>
                                <div id="upload-status-text-upload" class="upload-status-text">Processing...</div>
                                <div id="upload-time-estimate-upload" class="upload-time-estimate"></div>
                            </div>
                        </div>
                        <!-- Web Add Card -->
                        <div class="add-card web-card">
                             <h4><i class="fas fa-link"></i> Add Web Page</h4>
                             <p class="card-description">Paste a single page URL.</p>
                            <input type="url" id="urlInputUpload" class="form-control url-input full-width url-input-styled" placeholder="https://...">
                            <button class="btn btn-secondary btn-crawl full-width" onclick="addWebsite()">Confirm Add</button>
                            <div id="add-website-status-upload" class="upload-status compact hidden">
                                <div class="upload-progress-container">
                                    <div id="add-website-progress-bar-upload" class="upload-progress-bar" style="width: 0%"></div>
                                </div>
                                <div id="add-website-status-text-upload" class="upload-status-text">Processing...</div>
                                <div id="add-website-time-estimate-upload" class="upload-time-estimate"></div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End upload-content-area -->
            </div> <!-- End upload-view -->

            <!-- New Library View (Initially Hidden) -->
            <div class="library-view hidden" id="library-view">
                <div class="library-header-controls">
                    <button class="btn btn-secondary back-button" id="back-to-chat-btn">
                        <i class="fas fa-arrow-left"></i> Back to Chat
                    </button>
                </div>
                
                <!-- Content area for library sections -->
                <div class="library-content-area"> 

                    <!-- Bottom Row: Document List -->
                    <div class="library-section document-list-section" id="document-library"> 
                        <div class="library-header list-header" id="library-toggle" onclick="toggleLibraryListDisplay()">
                            <h3><i class="fas fa-book"></i> Your Documents 
                                <span class="notification-badge" style="display: none;">0</span> 
                            </h3>
                            <i class="fas fa-chevron-down library-toggle-icon"></i>
                        </div>
                        <div id="document-list" class="document-list">
                            <div class="document-loading">Loading documents...</div>
                        </div>
                        <div class="bulk-actions">
                            <button class="btn btn-delete small-btn" onclick="deleteSelectedFiles()"> 
                                <i class="fas fa-trash-alt"></i> Delete Selected
                            </button>
                         </div>
                    </div>
                    
                     <!-- Actions Section (Below List) -->
                     <div class="library-section actions-section centered-actions">
                         <div class="action-buttons-container">
                            <button class="btn btn-danger" onclick="resetSession()">
                                <i class="fas fa-power-off"></i> Reset Full Session (Delete Library)
                            </button>
                        </div>
                    </div>
                </div> <!-- End library-content-area -->
            </div> <!-- End library-view -->

        </div> <!-- End main-content-area -->
    </div> <!-- End app-container -->

    <script>
        // Move element selections and event listeners inside DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to main view elements
            const chatArea = document.getElementById('chat-area');
            const libraryView = document.getElementById('library-view');
            const uploadView = document.getElementById('upload-view'); // Get upload view
            const showLibraryBtn = document.getElementById('show-library-btn');
            const showChatBtn = document.getElementById('show-chat-btn'); // Get chat button
            const showUploadBtn = document.getElementById('show-upload-btn'); // Get upload button
            const backToChatBtn = document.getElementById('back-to-chat-btn');
            const backToChatBtnUpload = document.getElementById('back-to-chat-btn-upload'); // Get upload back button
            const fileInput = document.getElementById('fileInput'); 
            const fileInputUploadView = document.getElementById('fileInputUploadView'); // Input for upload view
            const fileInfoUpload = document.getElementById('file-info-upload'); // Info for upload view
            const userInput = document.getElementById('userInput'); 
            // Select the original send button (now acting as clear) by its temporary ID
            const sendButtonActsAsClear = document.getElementById('send-button'); 
            console.log('DOMContentLoaded: Found sendButtonActsAsClear:', sendButtonActsAsClear);
            
            // Remove Tab Elements selection
            // const tabButtons = document.querySelectorAll('.tab-nav .tab-button');
            // const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
            
            // Remove Tab Switching Logic 
            /*
            function switchTab(event) {
                // ... (removed function body)
            }
            */

            // Remove event listeners for tabs
            /* 
            tabButtons.forEach(button => {
                button.addEventListener('click', switchTab);
            });
            */
            // --- End Removal of Tab Logic ---
            
            // --- View Switching Logic --- 
            function showView(viewToShow) {
                console.log(`[showView] Called. Attempting to show: ${viewToShow ? viewToShow.id : 'null'}`);
                // Hide all main views first
                try {
                     if (chatArea) {
                        console.log('[showView] Hiding chatArea');
                        chatArea.classList.add('hidden');
                    } else { console.log('[showView] chatArea not found'); }
                     if (libraryView) {
                        console.log('[showView] Hiding libraryView');
                        libraryView.classList.add('hidden');
                    } else { console.log('[showView] libraryView not found'); }
                     if (uploadView) {
                        console.log('[showView] Hiding uploadView');
                        uploadView.classList.add('hidden');
                    } else { console.log('[showView] uploadView not found'); }

                     // Show the selected view
                     if (viewToShow) {
                        console.log(`[showView] Showing ${viewToShow.id}`);
                        viewToShow.classList.remove('hidden');
                        console.log(`[showView] Successfully showed ${viewToShow.id}`);
                    } else {
                        console.log('[showView] No view to show was provided.');
                     }
                } catch (e) {
                    console.error('[showView] Error during hide/show:', e);
                }
                console.log('[showView] Finished.');
            }
    
            function showLibrary() {
                console.log('[showLibrary] Called');
                showView(libraryView);
                fetchDocuments(); // Refresh documents when showing library
            }
    
            function showChat() {
                console.log('[showChat] Called');
                showView(chatArea);
            }
    
            function showUpload() {
                console.log('[showUpload] Called');
                showView(uploadView);
                // Potentially clear upload status here if needed
            }

            // Add event listeners for view switching
            if (showLibraryBtn) {
                // Toggle Library/Chat view -> Change back to always show Library
                showLibraryBtn.addEventListener('click', () => {
                    showLibrary();
                });
            }
            if (showUploadBtn) {
                // Add event listener for the new Chat button
                if (showChatBtn) {
                    showChatBtn.addEventListener('click', () => {
                        showChat();
                    });
                }
                
                // Event listener for Upload button -> Change back to always show Upload
                showUploadBtn.addEventListener('click', () => {
                    showUpload();
                });
            }
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', showChat);
            }
            if (backToChatBtnUpload) {
                backToChatBtnUpload.addEventListener('click', showChat);
            }
            
            // --- Restore Original Send Button Listener ---
            const sendButton = document.getElementById('send-button'); // Get correct ID
            console.log('DOMContentLoaded: Found sendButton:', sendButton); // Log again

            // Remove listener attachment for the temporary clear button ID if it exists
            /*
            const sendButtonActsAsClear = document.getElementById('send-button-temp-clear'); // ID no longer exists
            if (sendButtonActsAsClear) {
                // sendButtonActsAsClear.removeEventListener('click', clearChatUI); // Clean up just in case
            }
            */

            // Add event listener for Send Button (programmatically)
            if (sendButton) {
                console.log('Attaching click listener to sendButton');
                sendButton.addEventListener('click', sendMessage);
            } else {
                console.error('Could not attach listener: sendButton not found!');
            }
             // Remove the temporary listener attachment for clearChatUI
            /*
            if (sendButtonActsAsClear) {
                console.log('Attaching click listener (clearChatUI) to original send button'); 
                sendButtonActsAsClear.addEventListener('click', clearChatUI);
            }
            */
            // --- End Restore Original Send Button Listener ---
            
            // Set initial view
            showChat(); // Start with chat view visible
            fetchDocuments(); // Initial document load for the library

             // Update file info display for UPLOAD view
            if (fileInputUploadView && fileInfoUpload) {
                fileInputUploadView.addEventListener('change', () => {
                    if (fileInputUploadView.files.length > 0) {
                        const fileNames = Array.from(fileInputUploadView.files).map(f => f.name).join(', ');
                        fileInfoUpload.textContent = `${fileInputUploadView.files.length} file(s): ${fileNames}`;
                    } else {
                        fileInfoUpload.textContent = 'No files selected';
                    }
                });
            }
            
            // Send message on Enter key press (now inside DOMContentLoaded)
            if (userInput) {
                 userInput.addEventListener('keypress', function(e) {
                    console.log('Keypress event fired:', e.key); // Log the key pressed
                    if (e.key === 'Enter' && !e.shiftKey) {
                        console.log('Enter key detected, calling sendMessage...'); // Log detection
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // Add event listeners to checkboxes for managing bulk delete button
            // Ensure this runs after elements are available
            document.addEventListener('change', function(event) {
                if (event.target.matches('#document-list .document-checkbox')) {
                    manageBulkDeleteButton();
                }
            });
            
            // Call initial management of button visibility
            manageBulkDeleteButton();
            toggleLibraryListDisplay(); // Set initial state of list display
            
        }); // End DOMContentLoaded
        // --- End View Switching Logic ---
        
        // --- Globally Defined Functions (Keep these outside DOMContentLoaded if they don't rely on elements directly on load) ---
        
        function addMessage(message, isUser) {
            console.log('addMessage called. Message:', message, 'isUser:', isUser); // Log entry
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) {
                 console.error('addMessage: chatContainer not found!'); // Log error
                 return; 
            }
            console.log('addMessage: Found chatContainer', chatContainer); // Log container found

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            console.log('addMessage: Created messageDiv with class:', messageDiv.className); // Log div creation

            // Basic Markdown support (bold, italics) - Optional enhancement
            let processedMessage = message;
            try {
                 // Ensure message is a string before replacing
                 if (typeof processedMessage !== 'string') {
                     processedMessage = String(processedMessage); 
                 }
                 processedMessage = processedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                 processedMessage = processedMessage.replace(/\*(.*?)\*/g, '<em>$1</em>');       // Italics
                 processedMessage = processedMessage.replace(/\n/g, '<br>'); // Convert newlines
            } catch (e) {
                console.error('Error processing message markdown/newlines:', e);
                // Use original message if processing fails
                processedMessage = message; 
            }

            messageDiv.innerHTML = processedMessage; 
            chatContainer.appendChild(messageDiv);
            console.log('addMessage: Appended messageDiv to chatContainer'); // Log append
            
            // Scroll to the bottom smoothly
            try {
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
                console.log('addMessage: Scrolled to bottom.'); // Log scroll
            } catch (e) {
                 console.error('Error scrolling chat container:', e);
            }
        }

        // --- Restore Original sendMessage Logic ---
        async function sendMessage() {
            console.log('sendMessage function called');
            const userInput = document.getElementById('userInput');
            const chatContainer = document.getElementById('chatContainer');
            console.log('sendMessage: userInput:', userInput, 'chatContainer:', chatContainer);

            if (!userInput || !chatContainer) {
                console.error('Required elements not found for sendMessage.');
                return;
            }

            const message = userInput.value.trim();

            if (message) {
                console.log('User message detected:', message); // Log before adding
                addMessage(message, true);
                console.log('Called addMessage for user message.'); // Log after adding
                userInput.value = ''; // Clear input after sending

                try {
                    const response = await fetch(`/search?query=${encodeURIComponent(message)}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        addMessage(`Server Error: ${response.status} ${response.statusText}. ${errorText}`, false);
                    } else {
                        console.log('Received 200 OK from /search.');
                        try {
                            const responseText = await response.text(); 
                            console.log('Successfully read response body as text:', responseText);
                            
                            // --- Re-enable JSON parse and addMessage --- 
                            const data = JSON.parse(responseText); 
                            console.log('Successfully parsed JSON data:', data);
                            const botResponseText = data.response || 'Parsed JSON but key \'response\' missing.';
                            console.log('Attempting to add bot message:', botResponseText);
                            addMessage(botResponseText, false);
                            // --- End Re-enabled Section --- 
                            
                        } catch (readOrParseError) { // Catch errors from .text() OR JSON.parse() OR addMessage
                            console.error('Error reading/parsing/displaying response body:', readOrParseError);
                            addMessage(`Error: Could not process/display server response. (${readOrParseError.message})`, false);
                        }
                    }
                } catch (fetchError) { 
                    console.error("Network fetch error:", fetchError); 
                    addMessage(`Network Error: Could not connect to the server. (${fetchError.message})`, false);
                }
            }
        }
        // --- End Restore Original sendMessage Logic ---

        async function uploadFiles() {
            console.log('uploadFiles function called for Upload View');
            const fileInput = document.getElementById('fileInputUploadView');
            const fileInfo = document.getElementById('file-info-upload');
            console.log('uploadFiles: fileInput:', fileInput, 'fileInfo:', fileInfo);
            
            if (!fileInput || fileInput.files.length === 0) {
                alert('Please select at least one file using the "Upload Documents" button first.');
                return;
            }

            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('files', file);
            }
            
            // Get status elements for Upload View
            const uploadStatus = document.getElementById('upload-status-upload');
            const uploadProgressBar = document.getElementById('upload-progress-bar-upload');
            const uploadStatusText = document.getElementById('upload-status-text-upload');
            const uploadTimeEstimate = document.getElementById('upload-time-estimate-upload');
            const confirmButton = document.querySelector('#upload-view .btn-trigger-upload'); // Target button in upload view
            console.log('uploadFiles: status elements:', { uploadStatus, uploadProgressBar, uploadStatusText, uploadTimeEstimate, confirmButton });
            
            if (!uploadStatus || !uploadProgressBar || !uploadStatusText || !uploadTimeEstimate) {
                 console.error('Upload status/progress elements not found!');
                 alert('UI error: Could not display upload progress.');
                 return;
             }
            
            // --- Start: Restored Logic --- 
            if (uploadStatus) uploadStatus.classList.remove('hidden');
            if (uploadProgressBar) {
                 uploadProgressBar.style.width = '5%'; 
                 uploadProgressBar.style.backgroundColor = 'var(--accent-color)'; // Reset color
            }
            if (uploadStatusText) uploadStatusText.textContent = 'Starting upload...';
            
            // Calculate estimated time 
            const estimatedTimeSeconds = 3; // Start with 3 seconds estimate
            if (uploadTimeEstimate) uploadTimeEstimate.textContent = `Estimated time remaining: ~${estimatedTimeSeconds} seconds`;
            
            // Set up progress simulation 
            let progress = 5;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 5; 
                    if (uploadProgressBar) uploadProgressBar.style.width = `${Math.min(progress, 95)}%`; // Cap at 95% before fetch finishes
                    
                    if (uploadStatusText) {
                        if (progress < 30) uploadStatusText.textContent = 'Uploading files...';
                        else if (progress < 60) uploadStatusText.textContent = 'Processing content...';
                        else uploadStatusText.textContent = 'Analyzing & Indexing...';
                    }
                    
                    // Update remaining time estimate text based on progress
                    if (uploadTimeEstimate) {
                        if (progress > 66) {
                            uploadTimeEstimate.textContent = 'Estimated time remaining: ~1 second';
                        } else if (progress > 33) {
                            uploadTimeEstimate.textContent = 'Estimated time remaining: ~2 seconds';
                        }
                    }
                }
            }, 500);
            
            // Disable upload button
            if(confirmButton) confirmButton.disabled = true;

            try {
                const response = await fetch('/upload', { // Correct endpoint
                    method: 'POST',
                    body: formData
                });

                // Clear interval and set to 100% when fetch is done
                clearInterval(progressInterval);
                if (uploadProgressBar) uploadProgressBar.style.width = '100%';
                
                const data = await response.json(); // Read JSON data first

                if (!response.ok) {
                     // Use error message from JSON if available
                    throw new Error(data.error || `Processing failed: ${response.status}`); 
                }

                // Update upload status with success
                if (uploadStatusText) uploadStatusText.textContent = `Success: ${data.document_count} document(s) added.`;
                if (uploadTimeEstimate) uploadTimeEstimate.textContent = ''; // Clear time estimate on success
                
                // Log before updating list
                console.log('Upload successful. Response data:', data);
                console.log('Calling updateDocumentList with:', data.documents);

                // Update document library
                if (data.documents) { // Check if documents array exists in response
                    updateDocumentList(data.documents);
                } else {
                    console.warn('No documents array found in successful upload response:', data);
                    fetchDocuments(); // Fallback to fetching all documents again
                }
                
                // Reset file inputs
                if(fileInfo) fileInfo.textContent = 'No files selected';
                if(fileInput) fileInput.value = '';

                 // Hide status after delay on success
                 setTimeout(() => {
                    if (uploadStatus) uploadStatus.classList.add('hidden');
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                 }, 3000); 

            } catch (error) {
                clearInterval(progressInterval); // Stop progress on error too
                console.error("Upload error:", error);
                
                // Update upload status with error
                if (uploadStatusText) uploadStatusText.textContent = `Error: ${error.message}`;
                if (uploadTimeEstimate) uploadTimeEstimate.textContent = ''; // Clear estimate
                if (uploadProgressBar) {
                    uploadProgressBar.style.width = '100%'; // Show full bar as red
                    uploadProgressBar.style.backgroundColor = 'var(--error-color)';
                }
                 // Optionally add error to chat? 
                 // addMessage(`Error uploading files: ${error.message}`, false);
                 
                 // Hide status after longer delay on error
                 setTimeout(() => {
                    if (uploadStatus) uploadStatus.classList.add('hidden');
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                 }, 5000); 
                
            } finally {
                // Re-enable upload button regardless of success/error
                if(confirmButton) confirmButton.disabled = false;
            }
            // --- End: Restored Logic --- 
        }

        // Function to update the document list UI (keep existing logic)
        function updateDocumentList(documents) {
             console.log('updateDocumentList function called with documents:', documents); // Log entry and data
             
             const docList = document.getElementById('document-list');
             const loadingDiv = docList ? docList.querySelector('.document-loading') : null; // Find loading div relative to docList
             const libraryToggle = document.getElementById('library-toggle');
             const notificationBadge = libraryToggle ? libraryToggle.querySelector('.notification-badge') : null;
             console.log('updateDocumentList: Found elements:', { docList, loadingDiv, notificationBadge }); // Log found elements

             if (!docList) {
                 console.error('Could not find #document-list element to update.');
                 return; // Exit if list container not found
             }

             // Clear current list (excluding loading state initially)
             docList.innerHTML = ''; 

             if (documents && Array.isArray(documents) && documents.length > 0) {
                 console.log(`updateDocumentList: Processing ${documents.length} documents.`);
                 documents.forEach((doc, index) => {
                    console.log(`updateDocumentList: Creating element for doc ${index}:`, doc); // Log each doc being processed
                    const item = document.createElement('div');
                    const textSpan = document.createElement('span');
                    textSpan.textContent = doc.title || doc.filename || doc.source_url || 'Unnamed Document'; 
                    textSpan.className = 'document-text';
                    item.appendChild(textSpan);
                    
                    docList.appendChild(item);
                 });
                 console.log('updateDocumentList: Finished adding document elements.');
                 // Update badge count
                 if (notificationBadge) {
                     notificationBadge.textContent = documents.length.toString();
                     notificationBadge.style.display = 'inline-block';
                 }
             } else {
                 console.log('updateDocumentList: No documents array or empty array received.');
                 docList.innerHTML = '<div class="document-loading">No documents in library. Add some!</div>'; // Updated empty message
                 if (notificationBadge) {
                     notificationBadge.textContent = '0';
                     notificationBadge.style.display = 'none';
                 }
             }
        }

        async function addWebsite() { 
            console.log('addWebsite function called'); // Debug log
            // Accessing urlInput etc. needs them passed or defined globally/higher scope
            const urlInput = document.getElementById('urlInputUpload'); // Target input in upload view
            console.log('addWebsite: urlInput:', urlInput); // Debug log
            if (!urlInput) {
                console.error('URL input element not found!');
                alert('UI error: Could not find URL input field.');
                return;
            }
            const url = urlInput.value.trim();

            if (!url) {
                alert('Please enter a valid website URL.');
                return;
            }
            
             // Validate URL format (basic)
            try {
                new URL(url);
            } catch (_) {
                alert('Invalid URL format. Please include http:// or https://');
                return;
            }

            // Show status indicator for Upload View
            const statusContainer = document.getElementById('add-website-status-upload');
            const progressBar = document.getElementById('add-website-progress-bar-upload');
            const statusText = document.getElementById('add-website-status-text-upload');
            const addButton = document.querySelector('#upload-view .btn-crawl'); // Target button in upload view
            const timeEstimateText = document.getElementById('add-website-time-estimate-upload'); // Get time estimate element
            console.log('addWebsite: status elements:', { statusContainer, progressBar, statusText, addButton, timeEstimateText });
            
            if (!statusContainer || !progressBar || !statusText) {
                console.error('Add Website status/progress elements not found!');
                alert('UI error: Could not display progress for adding website.');
                return;
            }

            if (statusContainer) statusContainer.classList.remove('hidden');
            if (progressBar) {
                progressBar.style.width = '10%'; 
                progressBar.style.backgroundColor = 'var(--accent-color)'; // Reset color
            }
            if (statusText) statusText.textContent = 'Initiating request...'; // Initial status
            if (addButton) addButton.disabled = true; 

            // Display estimated time
            if (timeEstimateText) timeEstimateText.textContent = 'Estimated time remaining: ~3 seconds';

            // Simulate progress (Mimicking upload stages)
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10; // Adjust increment rate if needed
                    if (progressBar) progressBar.style.width = `${Math.min(progress, 95)}%`; // Cap progress
                    
                    // Update status text based on simulated progress
                    if (statusText) {
                        if (progress < 40) statusText.textContent = 'Fetching website content...';
                        else if (progress < 75) statusText.textContent = 'Analyzing content...'; 
                        else statusText.textContent = 'Saving to library...'; 
                    }
                    
                    // Update remaining time estimate text based on progress
                    if (timeEstimateText) {
                        if (progress > 66) {
                            timeEstimateText.textContent = 'Estimated time remaining: ~1 second';
                        } else if (progress > 33) {
                            timeEstimateText.textContent = 'Estimated time remaining: ~2 seconds';
                        }
                    }
                }
            }, 700); // Adjust interval timing if desired

            try {
                const response = await fetch('/crawl', { // Corrected endpoint URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) { throw new Error(`Add Website failed: ${response.status}`); }
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Adding page failed: ${response.status}`);
                }

                if (statusText) statusText.textContent = 'Website added successfully!';
                if (timeEstimateText) timeEstimateText.textContent = ''; // Clear estimate on success
                updateDocumentList(data.documents); 
                if (urlInput) urlInput.value = ''; 

                // Hide status after a short delay
                setTimeout(() => {
                    if (statusContainer) statusContainer.classList.add('hidden');
                    if (progressBar) progressBar.style.width = '0%';
                    if (timeEstimateText) timeEstimateText.textContent = ''; // Ensure it's cleared
                }, 3000); // Short delay on success

            } catch (error) {
                clearInterval(progressInterval);
                console.error("Add Website error:", error);
                if (statusText) statusText.textContent = `Error: ${error.message}`; 
                if (progressBar) { // Indicate error on progress bar
                    progressBar.style.width = '100%'; 
                    progressBar.style.backgroundColor = 'var(--error-color)';
                }
                if (timeEstimateText) timeEstimateText.textContent = ''; // Clear estimate on error
                 
                 setTimeout(() => {
                    if (statusContainer) statusContainer.classList.add('hidden');
                    if (progressBar) progressBar.style.width = '0%';
                    if (timeEstimateText) timeEstimateText.textContent = ''; // Ensure it's cleared
                 }, 5000); // Longer delay on error
                 addMessage(`Failed to add ${url}. Error: ${error.message}`, false);

            } finally {
                 if (addButton) addButton.disabled = false; 
            }
        }

        // Function to fetch and display documents on page load/update
        async function fetchDocuments() {
             try {
                const response = await fetch('/documents');
                if (response.ok) {
                    const data = await response.json();
                    updateDocumentList(data.documents); // Update list in the library view
                } else {
                    console.error("Failed to load documents, status:", response.status);
                    updateDocumentList([]); // Clear list on error
                }
            } catch (error) {
                console.error("Error loading documents:", error);
                updateDocumentList([]); // Clear list on error
            }
        }
        
        // Toggle for the document list *within* the library view
        function toggleLibraryListDisplay() {
            const documentList = document.getElementById('document-list');
            const toggleIcon = document.querySelector('#library-toggle .library-toggle-icon');
            const bulkActions = document.querySelector('#document-library .bulk-actions');
            if (documentList && toggleIcon) {
                documentList.classList.toggle('visible');
                toggleIcon.classList.toggle('fa-chevron-down');
                toggleIcon.classList.toggle('fa-chevron-up');
                if (bulkActions) {
                   bulkActions.style.display = documentList.classList.contains('visible') ? 'block' : 'none';
                }
                // Maybe call manageBulkDeleteButton here too
            }
        }
        
        // Manage bulk delete button visibility based on selections
        function manageBulkDeleteButton() {
            const checkboxes = document.querySelectorAll('#document-list .document-checkbox:checked');
            const deleteButton = document.querySelector('.bulk-actions .btn-delete');
            if (deleteButton) {
                deleteButton.style.display = checkboxes.length > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Modified delete function to handle selected files
        async function deleteSelectedFiles() {
            const checkedBoxes = document.querySelectorAll('#document-list .document-checkbox:checked');
            const documentIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (documentIds.length === 0) {
                alert('Please select at least one document to delete.');
                return;
            }

            if (!confirm(`Are you sure you want to delete the selected ${documentIds.length} document(s)?`)) {
                return;
            }

            try {
                const response = await fetch('/delete_documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ document_ids: documentIds })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Delete failed: ${response.status}. ${errorText}`);
                }

                const data = await response.json();
                updateDocumentList(data.documents); // Refresh the list
                addMessage(data.message || 'Selected documents deleted.', false); // Show message in chat? Or maybe an alert?
                 alert(data.message || 'Selected documents deleted successfully.'); // Use alert for library view feedback
                 manageBulkDeleteButton(); // Hide button again

            } catch (error) {
                console.error("Delete error:", error);
                 alert(`Error deleting selected documents: ${error.message}`);
                // addMessage(`Error deleting selected documents: ${error.message}`, false);
            }
        }
        
        // Keep clearChatUI (unchanged from previous state)
        async function clearChatUI() {
            console.log('clearChatUI function called (via Send btn maybe?)'); // Added log
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            chatContainer.innerHTML = '<div class="message bot-message">Chat cleared. Your library remains unchanged.</div>';
        }

        // Keep resetSession (affects backend and library)
        async function resetSession() {
            console.log('[resetSession] Function entered.');
            if (!confirm('This will reset the entire session, deleting all documents from your library and the index. Are you sure?')) {
                return;
            }
            console.log('[resetSession] Confirmed. Attempting POST request to /reset_session...');

            try {
                const response = await fetch('/reset_session', { method: 'POST' });

                if (!response.ok) {
                    // Try to get more specific error info if possible
                    let errorMsg = `Server responded with status ${response.status}`;
                    try {
                        const errorData = await response.json(); // Check if backend sends JSON error
                        errorMsg += `: ${errorData.error || response.statusText}`;
                    } catch (e) {
                        // If response wasn't JSON, just use status text
                        errorMsg += `: ${response.statusText}`;
                    }
                    console.error(`[resetSession] Backend error: ${errorMsg}`);
                    addMessage(`Error resetting session: ${errorMsg}`, false);
                    alert(`Error resetting session: ${errorMsg}`); // Also show alert
                    return; // Stop if backend failed
                }

                // If response.ok is true
                const data = await response.json(); // Assume success response is JSON
                console.log('[resetSession] Backend call successful. Response:', data);
                addMessage(data.message || "Session reset complete. Library cleared.", false);
                fetchDocuments(); // Refresh the library view (which will show it's empty)
                // Optional: Switch back to chat view if desired
                // showChat(); 
                alert(data.message || "Session reset successfully!"); // Confirmation alert

            } catch (networkError) {
                // Handle network errors (e.g., server down, DNS issues)
                console.error("[resetSession] Network or fetch error:", networkError);
                addMessage(`Network Error: Could not reach server to reset session. (${networkError.message})`, false);
                alert(`Network Error: Could not reach server to reset session. Please check if the server is running. (${networkError.message})`);
            }
        }

    </script>
</body>
</html>